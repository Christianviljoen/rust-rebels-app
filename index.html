<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rust Rebels | Quotes & Hours</title>
  <meta name="theme-color" content="#111111" />
  <style>
    :root{
      --bg:#0b0b0c; --card:#141416; --muted:#9aa0a6; --text:#f2f3f4;
      --accent:#f5b301; --danger:#ff5a5f; --ok:#4ade80; --line:#24262a;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 16px;
      --font: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f7f8; --card:#ffffff; --muted:#5f6368; --text:#111; --line:#e8eaed; --shadow: 0 10px 25px rgba(0,0,0,.08); }
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:var(--font); }
    header{
      position:sticky; top:0; z-index:20;
      background: linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,0));
      backdrop-filter: blur(10px);
      padding:14px 16px 10px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{
      width:34px; height:34px; border-radius:10px;
      background: radial-gradient(circle at 30% 30%, var(--accent), #ff6a00);
      box-shadow: var(--shadow);
    }
    h1{ font-size:16px; margin:0; letter-spacing:.2px; }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }

    main{ padding: 6px 16px 90px; max-width: 980px; margin: 0 auto; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px;
    }
    .card h2{ margin:0 0 10px; font-size:14px; }
    .grow{ flex: 1 1 340px; }
    .side{ flex: 1 1 260px; }

    label{ display:block; font-size:12px; color:var(--muted); margin: 10px 0 6px; }
    input, textarea, select{
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid var(--line); background:transparent; color:var(--text);
      outline:none;
    }
    textarea{ min-height:84px; resize:vertical; }
    .btn{
      border:none; border-radius:12px; padding:12px 12px; font-weight:600;
      background: var(--line); color:var(--text);
      cursor:pointer;
    }
    .btn.primary{ background: var(--accent); color:#111; }
    .btn.danger{ background: var(--danger); color:white; }
    .btn.ghost{ background: transparent; border:1px solid var(--line); }
    .btn:active{ transform: translateY(1px); }

    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px; border:1px solid var(--line); border-radius:999px;
      color:var(--muted); font-size:12px;
    }
    .jobs{ display:flex; flex-direction:column; gap:10px; }
    .jobItem{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      padding:12px; border:1px solid var(--line); border-radius:14px;
      background: rgba(255,255,255,0.02);
      cursor:pointer;
    }
    .jobTitle{ font-weight:700; font-size:14px; margin:0; }
    .jobMeta{ margin:4px 0 0; font-size:12px; color:var(--muted); }
    .badge{ font-size:11px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); white-space:nowrap; }
    .badge.quote{ border-color: rgba(245,179,1,.4); color: var(--accent); }
    .badge.progress{ border-color: rgba(96,165,250,.35); color: #60a5fa; }
    .badge.done{ border-color: rgba(74,222,128,.35); color: var(--ok); }
    .badge.invoiced{ border-color: rgba(168,85,247,.35); color: #a855f7; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin: 6px 0 12px; }
    .tab{ padding:10px 12px; border-radius:999px; border:1px solid var(--line); background:transparent; color:var(--muted); cursor:pointer; font-weight:700; font-size:12px; }
    .tab.active{ background: var(--line); color: var(--text); }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:720px){ .grid2{ grid-template-columns:1fr; } }

    table{ width:100%; border-collapse:collapse; }
    th, td{ text-align:left; font-size:12px; padding:10px 8px; border-bottom:1px solid var(--line); vertical-align:top; }
    th{ color:var(--muted); font-weight:700; }
    .right{ text-align:right; }
    .muted{ color:var(--muted); }
    .kpi{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .kpi .pill b{ color:var(--text); }

    footer{
      position:fixed; bottom:0; left:0; right:0;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--line);
      padding:10px 16px;
    }
    .footerInner{ max-width:980px; margin:0 auto; display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .small{ font-size:12px; color:var(--muted); }
    .hidden{ display:none !important; }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>Rust Rebels</h1>
      <div class="sub">Quotes & Hours (local-only, no GST)</div>
    </div>
  </div>
</header>

<main>
  <div class="row">
    <section class="card grow">
      <h2>Jobs</h2>
      <div class="toolbar">
        <input id="search" placeholder="Search client / job / notes…" />
        <select id="filterStatus" style="max-width:220px">
          <option value="">All statuses</option>
          <option value="QUOTE">Quote</option>
          <option value="IN_PROGRESS">In Progress</option>
          <option value="COMPLETED">Completed</option>
          <option value="INVOICED">Invoiced</option>
        </select>
        <button class="btn primary" id="newJobBtn">+ New Job</button>
      </div>
      <div class="kpi" id="kpis"></div>
      <div style="height:10px"></div>
      <div class="jobs" id="jobList"></div>
    </section>

    <section class="card side" id="settingsCard">
      <h2>Settings</h2>
      <label>Default hourly rate ($/hr)</label>
      <input id="defaultRate" type="number" step="0.01" />
      <label>Business details (shown on PDFs)</label>
      <input id="bizName" placeholder="Business name" />
      <input id="bizPhone" placeholder="Phone" />
      <input id="bizEmail" placeholder="Email" />
      <input id="bizAddress" placeholder="Address" />
      <div style="height:12px"></div>
      <div class="toolbar">
        <button class="btn" id="backupBtn">Export backup (JSON)</button>
        <label class="btn ghost" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
          Import backup
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </label>
        <button class="btn danger" id="wipeBtn">Clear all data</button>
      </div>
      <div class="small" style="margin-top:10px">
        Tip: For PDF export, open “Generate PDF” and use the iOS Share button to save/send the PDF.
      </div>
    </section>
  </div>

  <section class="card hidden" id="jobCard" style="margin-top:14px;">
    <div class="toolbar" style="justify-content:space-between; align-items:center;">
      <div>
        <h2 id="jobHeader" style="margin:0">Job</h2>
        <div class="sub" id="jobSub"></div>
      </div>
      <div class="toolbar">
        <button class="btn ghost" id="closeJobBtn">Close</button>
        <button class="btn danger" id="deleteJobBtn">Delete</button>
      </div>
    </div>

    <div class="tabs" style="margin-top:12px;">
      <button class="tab active" data-tab="details">Details</button>
      <button class="tab" data-tab="time">Hours</button>
      <button class="tab" data-tab="materials">Materials</button>
      <button class="tab" data-tab="pdf">PDF</button>
    </div>

    <div id="tab-details">
      <div class="grid2">
        <div>
          <label>Client name</label>
          <input id="jobClient" />
        </div>
        <div>
          <label>Status</label>
          <select id="jobStatus">
            <option value="QUOTE">Quote</option>
            <option value="IN_PROGRESS">In Progress</option>
            <option value="COMPLETED">Completed</option>
            <option value="INVOICED">Invoiced</option>
          </select>
        </div>
      </div>

      <label>Job title</label>
      <input id="jobTitle" />

      <label>Description</label>
      <textarea id="jobDesc"></textarea>

      <div class="grid2">
        <div>
          <label>Location (optional)</label>
          <input id="jobLocation" />
        </div>
        <div>
          <label>Hourly rate override ($/hr, optional)</label>
          <input id="jobRate" type="number" step="0.01" placeholder="Leave blank to use default" />
        </div>
      </div>

      <label>Notes</label>
      <textarea id="jobNotes"></textarea>

      <div style="height:12px"></div>
      <button class="btn primary" id="saveJobBtn">Save job</button>
    </div>

    <div id="tab-time" class="hidden">
      <h2 style="font-size:13px; margin:0 0 10px;">Add hours</h2>
      <div class="grid2">
        <div>
          <label>Date</label>
          <input id="tDate" type="date" />
        </div>
        <div>
          <label>Rate used ($/hr)</label>
          <input id="tRate" type="number" step="0.01" />
        </div>
      </div>
      <div class="grid2">
        <div>
          <label>Start time (optional)</label>
          <input id="tStart" type="time" />
        </div>
        <div>
          <label>End time (optional)</label>
          <input id="tEnd" type="time" />
        </div>
      </div>
      <div class="grid2">
        <div>
          <label>OR Duration (hours)</label>
          <input id="tDuration" type="number" step="0.01" placeholder="e.g. 2.5" />
        </div>
        <div>
          <label>Break minutes</label>
          <input id="tBreak" type="number" step="1" value="0" />
        </div>
      </div>
      <label>Work description</label>
      <input id="tDesc" placeholder="e.g. Fitment + welding" />
      <div style="height:10px"></div>
      <button class="btn primary" id="addTimeBtn">Add entry</button>

      <div style="height:16px"></div>
      <h2 style="font-size:13px; margin:0 0 8px;">Entries</h2>
      <div class="pill" id="timeTotals"></div>
      <div style="height:10px"></div>
      <div style="overflow:auto">
        <table id="timeTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th class="right">Hours</th>
              <th class="right">$</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="tab-materials" class="hidden">
      <h2 style="font-size:13px; margin:0 0 10px;">Add material/expense</h2>
      <div class="grid2">
        <div>
          <label>Item</label>
          <input id="mItem" placeholder="e.g. Steel plate 6mm" />
        </div>
        <div>
          <label>Quantity</label>
          <input id="mQty" type="number" step="0.01" value="1" />
        </div>
      </div>
      <div class="grid2">
        <div>
          <label>Unit cost ($)</label>
          <input id="mUnit" type="number" step="0.01" value="0" />
        </div>
        <div>
          <label>Sell price override (optional, $)</label>
          <input id="mSell" type="number" step="0.01" placeholder="Leave blank = qty * unit cost" />
        </div>
      </div>
      <label>Notes (optional)</label>
      <input id="mNote" placeholder="e.g. Supplier invoice #123" />
      <div style="height:10px"></div>
      <button class="btn primary" id="addMatBtn">Add item</button>

      <div style="height:16px"></div>
      <h2 style="font-size:13px; margin:0 0 8px;">Items</h2>
      <div class="pill" id="matTotals"></div>
      <div style="height:10px"></div>
      <div style="overflow:auto">
        <table id="matTable">
          <thead>
            <tr>
              <th>Item</th>
              <th class="right">Qty</th>
              <th class="right">$</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="tab-pdf" class="hidden">
      <h2 style="font-size:13px; margin:0 0 10px;">Generate PDF</h2>
      <div class="grid2">
        <div>
          <label>Document type</label>
          <select id="pdfType">
            <option value="QUOTE">Quote</option>
            <option value="INVOICE">Invoice / Work Summary</option>
          </select>
        </div>
        <div>
          <label>Show itemised entries</label>
          <select id="pdfItemised">
            <option value="YES">Yes</option>
            <option value="NO">No (totals only)</option>
          </select>
        </div>
      </div>
      <label>Group hours by day</label>
      <select id="pdfGroupDays">
        <option value="NO">No</option>
        <option value="YES">Yes</option>
      </select>

      <div style="height:12px"></div>
      <button class="btn primary" id="genPdfBtn">Generate PDF</button>

      <div class="small" style="margin-top:10px">
        On iPhone/iPad: after it opens, tap Share → “Save to Files” to store the PDF, or share to email/WhatsApp.
      </div>
    </div>

  </section>
</main>
<div id="authModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; background:rgba(0,0,0,.55); backdrop-filter: blur(10px); z-index:9999;">
  <div style="max-width:420px; width:100%; background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:var(--shadow);">
    <h2 style="margin:0 0 6px; font-size:16px;">Rust Rebels Login</h2>
    <div style="color:var(--muted); font-size:12px; margin-bottom:10px;">Log in to sync across iPhone/iPad.</div>

    <label>Email</label>
    <input id="authEmail" type="email" placeholder="you@example.com" />

    <label>Password</label>
    <input id="authPassword" type="password" placeholder="••••••••" />

    <div style="height:12px;"></div>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn primary" id="btnLogin">Log in</button>
      <button class="btn" id="btnSignup">Sign up</button>
      <button class="btn ghost" id="btnOffline">Use offline (no sync)</button>
    </div>

    <div id="authMsg" style="margin-top:10px; font-size:12px; color:var(--muted);"></div>
  </div>
</div>
  
<footer>
  <div class="footerInner">
    <div class="small">Local-only storage. No GST. Default rate: <b id="rateFooter">$75</b>/hr</div>
    <div class="toolbar">
      <button class="btn" id="exportCsvBtn">Export jobs (CSV)</button>
    </div>
  </div>
</footer>

<script>
(() => {
  const STORAGE_KEY = "rr_quotes_hours_v1";

  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  const money = (n) => {
    const x = Number(n || 0);
    return x.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  };

  const hoursFromTimes = (start, end, breakMin) => {
    if(!start || !end) return null;
    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);
    let mins = (eh*60+em) - (sh*60+sm);
    if(mins < 0) mins += 24*60; // cross midnight
    mins -= Number(breakMin || 0);
    return Math.max(0, mins/60);
  };

  const state = loadState();

  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      try { return JSON.parse(raw); } catch {}
    }
    return {
      settings: {
        defaultRate: 75,
        biz: { name: "Rust Rebels", phone:"", email:"", address:"" }
      },
      jobs: []
    };
  }
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); renderAll(); }

  // Elements
  const jobList = document.getElementById("jobList");
  const jobCard = document.getElementById("jobCard");
  const settingsCard = document.getElementById("settingsCard");
  const kpis = document.getElementById("kpis");

  const search = document.getElementById("search");
  const filterStatus = document.getElementById("filterStatus");

  const defaultRate = document.getElementById("defaultRate");
  const bizName = document.getElementById("bizName");
  const bizPhone = document.getElementById("bizPhone");
  const bizEmail = document.getElementById("bizEmail");
  const bizAddress = document.getElementById("bizAddress");
  const rateFooter = document.getElementById("rateFooter");
  const newJobBtn = document.getElementById("newJobBtn");
  const closeJobBtn = document.getElementById("closeJobBtn");
  const deleteJobBtn = document.getElementById("deleteJobBtn");
  const saveJobBtn = document.getElementById("saveJobBtn");
  const backupBtn = document.getElementById("backupBtn");
  const wipeBtn = document.getElementById("wipeBtn");
  const importFile = document.getElementById("importFile");
  const exportCsvBtn = document.getElementById("exportCsvBtn");

  // Job fields
  const jobHeader = document.getElementById("jobHeader");
  const jobSub = document.getElementById("jobSub");
  const jobClient = document.getElementById("jobClient");
  const jobTitle = document.getElementById("jobTitle");
  const jobDesc = document.getElementById("jobDesc");
  const jobLocation = document.getElementById("jobLocation");
  const jobNotes = document.getElementById("jobNotes");
  const jobStatus = document.getElementById("jobStatus");
  const jobRate = document.getElementById("jobRate");

  // Time inputs
  const tDate = document.getElementById("tDate");
  const tRate = document.getElementById("tRate");
  const tStart = document.getElementById("tStart");
  const tEnd = document.getElementById("tEnd");
  const tDuration = document.getElementById("tDuration");
  const tBreak = document.getElementById("tBreak");
  const tDesc = document.getElementById("tDesc");
  const addTimeBtn = document.getElementById("addTimeBtn");
  const timeTableBody = document.querySelector("#timeTable tbody");
  const timeTotals = document.getElementById("timeTotals");

  // Materials inputs
  const mItem = document.getElementById("mItem");
  const mQty = document.getElementById("mQty");
  const mUnit = document.getElementById("mUnit");
  const mSell = document.getElementById("mSell");
  const mNote = document.getElementById("mNote");
  const addMatBtn = document.getElementById("addMatBtn");
  const matTableBody = document.querySelector("#matTable tbody");
  const matTotals = document.getElementById("matTotals");

  // PDF
  const pdfType = document.getElementById("pdfType");
  const pdfItemised = document.getElementById("pdfItemised");
  const pdfGroupDays = document.getElementById("pdfGroupDays");
  const genPdfBtn = document.getElementById("genPdfBtn");

  // Tabs
  const tabs = Array.from(document.querySelectorAll(".tab"));
  const tabPanels = {
    details: document.getElementById("tab-details"),
    time: document.getElementById("tab-time"),
    materials: document.getElementById("tab-materials"),
    pdf: document.getElementById("tab-pdf"),
  };

  let selectedJobId = null;

  function getJob(id){ return state.jobs.find(j => j.id === id); }

  function jobRateResolved(job){
    const r = job.rateOverride;
    return (r !== null && r !== undefined && r !== "") ? Number(r) : Number(state.settings.defaultRate || 0);
  }

  function calcLabor(job){
    const entries = job.timeEntries || [];
    let totalH = 0, total$ = 0;
    for(const e of entries){
      totalH += Number(e.hours || 0);
      total$ += Number(e.cost || 0);
    }
    return { hours: totalH, cost: total$ };
  }

  function calcMaterials(job){
    const items = job.materials || [];
    let total = 0;
    for(const it of items){
      total += Number(it.total || 0);
    }
    return { cost: total };
  }

  function badgeClass(status){
    if(status==="QUOTE") return "quote";
    if(status==="IN_PROGRESS") return "progress";
    if(status==="COMPLETED") return "done";
    if(status==="INVOICED") return "invoiced";
    return "";
  }
  function statusLabel(status){
    return status==="IN_PROGRESS" ? "In Progress" : status.charAt(0)+status.slice(1).toLowerCase().replace("_"," ");
  }

  // Settings init
  function initSettings(){
    defaultRate.value = state.settings.defaultRate ?? 75;
    bizName.value = state.settings.biz?.name ?? "Rust Rebels";
    bizPhone.value = state.settings.biz?.phone ?? "";
    bizEmail.value = state.settings.biz?.email ?? "";
    bizAddress.value = state.settings.biz?.address ?? "";
    rateFooter.textContent = "$" + money(state.settings.defaultRate ?? 75);
  }

  // Events settings
  defaultRate.addEventListener("input", () => {
    state.settings.defaultRate = Number(defaultRate.value || 0);
    saveState();
  });
  for(const [el, key] of [[bizName,"name"],[bizPhone,"phone"],[bizEmail,"email"],[bizAddress,"address"]]){
    el.addEventListener("input", () => {
      state.settings.biz = state.settings.biz || {};
      state.settings.biz[key] = el.value;
      saveState();
    });
  }

  newJobBtn.addEventListener("click", () => {
    const now = new Date().toISOString();
    const job = {
      id: uid(),
      client: "",
      title: "New job",
      desc: "",
      location: "",
      notes: "",
      status: "QUOTE",
      rateOverride: "",
      createdAt: now,
      updatedAt: now,
      timeEntries: [],
      materials: []
    };
    state.jobs.unshift(job);
    selectedJobId = job.id;
    saveState();
    openJob(job.id);
  });

  closeJobBtn.addEventListener("click", () => { selectedJobId = null; renderAll(); });

  deleteJobBtn.addEventListener("click", () => {
    const job = getJob(selectedJobId);
    if(!job) return;
    if(confirm("Delete this job? This cannot be undone.")){
      state.jobs = state.jobs.filter(j => j.id !== selectedJobId);
      selectedJobId = null;
      saveState();
    }
  });

  saveJobBtn.addEventListener("click", () => {
    const job = getJob(selectedJobId);
    if(!job) return;
    job.client = jobClient.value.trim();
    job.title = jobTitle.value.trim();
    job.desc = jobDesc.value.trim();
    job.location = jobLocation.value.trim();
    job.notes = jobNotes.value.trim();
    job.status = jobStatus.value;
    job.rateOverride = jobRate.value === "" ? "" : Number(jobRate.value);
    job.updatedAt = new Date().toISOString();
    saveState();
    alert("Saved.");
  });

  search.addEventListener("input", renderAll);
  filterStatus.addEventListener("change", renderAll);

  // Time add
  addTimeBtn.addEventListener("click", () => {
    const job = getJob(selectedJobId);
    if(!job) return;

    const date = tDate.value || new Date().toISOString().slice(0,10);
    const rate = Number(tRate.value || jobRateResolved(job));
    const br = Number(tBreak.value || 0);

    let hrs = null;
    const fromTimes = hoursFromTimes(tStart.value, tEnd.value, br);
    if(fromTimes !== null) hrs = fromTimes;

    const dur = tDuration.value !== "" ? Number(tDuration.value) : null;
    if(dur !== null && !isNaN(dur) && dur > 0) hrs = (dur - (br/60));

    if(hrs === null || isNaN(hrs) || hrs <= 0){
      alert("Enter start/end time OR a duration (hours).");
      return;
    }

    const desc = tDesc.value.trim() || "Work";
    const cost = hrs * rate;

    job.timeEntries.push({
      id: uid(),
      date,
      desc,
      hours: Number(hrs.toFixed(2)),
      rate,
      cost: Number(cost.toFixed(2)),
      start: tStart.value || "",
      end: tEnd.value || "",
      breakMin: br
    });
    job.updatedAt = new Date().toISOString();

    // reset some inputs
    tStart.value = ""; tEnd.value = ""; tDuration.value = ""; tDesc.value = ""; tBreak.value = "0";
    saveState();
  });

  // Materials add
  addMatBtn.addEventListener("click", () => {
    const job = getJob(selectedJobId);
    if(!job) return;

    const item = mItem.value.trim();
    if(!item){ alert("Enter an item name."); return; }

    const qty = Number(mQty.value || 1);
    const unit = Number(mUnit.value || 0);
    const sellOverride = (mSell.value === "" ? null : Number(mSell.value));
    const total = sellOverride !== null ? sellOverride : qty * unit;

    job.materials.push({
      id: uid(),
      item,
      qty: Number(qty.toFixed(2)),
      unit: Number(unit.toFixed(2)),
      sell: sellOverride,
      total: Number(total.toFixed(2)),
      note: mNote.value.trim()
    });
    job.updatedAt = new Date().toISOString();

    mItem.value=""; mQty.value="1"; mUnit.value="0"; mSell.value=""; mNote.value="";
    saveState();
  });

  // Tabs
  tabs.forEach(btn => btn.addEventListener("click", () => {
    tabs.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    const name = btn.dataset.tab;
    Object.entries(tabPanels).forEach(([k, el]) => el.classList.toggle("hidden", k !== name));
  }));

  // Backup export/import
  backupBtn.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    downloadBlob(blob, `rust-rebels-backup-${new Date().toISOString().slice(0,10)}.json`);
  });

  importFile.addEventListener("change", async () => {
    const f = importFile.files?.[0];
    if(!f) return;
    try{
      const txt = await f.text();
      const obj = JSON.parse(txt);
      if(!obj || !obj.settings || !obj.jobs) throw new Error("Invalid backup");
      if(confirm("Import backup? This will replace current data.")){
        state.settings = obj.settings;
        state.jobs = obj.jobs;
        selectedJobId = null;
        saveState();
      }
    }catch(e){
      alert("Could not import: " + e.message);
    }finally{
      importFile.value = "";
    }
  });

  wipeBtn.addEventListener("click", () => {
    if(confirm("Clear ALL data (jobs, hours, materials, settings)?")){
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
  });

  // CSV export (basic)
  exportCsvBtn.addEventListener("click", () => {
    const rows = [];
    rows.push(["JobID","Client","Title","Status","Rate","LaborHours","LaborCost","MaterialsCost","Total","UpdatedAt"].join(","));
    for(const j of state.jobs){
      const r = jobRateResolved(j);
      const labor = calcLabor(j);
      const mats = calcMaterials(j);
      const total = labor.cost + mats.cost;
      rows.push([
        j.id,
        csv(j.client), csv(j.title), j.status,
        r,
        labor.hours.toFixed(2),
        labor.cost.toFixed(2),
        mats.cost.toFixed(2),
        total.toFixed(2),
        j.updatedAt
      ].join(","));
    }
    const blob = new Blob([rows.join("\n")], {type:"text/csv"});
    downloadBlob(blob, `rust-rebels-jobs-${new Date().toISOString().slice(0,10)}.csv`);
  });

  function csv(s){
    const x = (s ?? "").toString().replaceAll('"','""');
    return `"${x}"`;
  }

  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

  // PDF generation (print to PDF)
  genPdfBtn.addEventListener("click", () => {
    const job = getJob(selectedJobId);
    if(!job) return;

    const docType = pdfType.value;
    const itemised = pdfItemised.value === "YES";
    const groupDays = pdfGroupDays.value === "YES";

    const labor = calcLabor(job);
    const mats = calcMaterials(job);
    const total = labor.cost + mats.cost;
    const rateUsed = jobRateResolved(job);
    const biz = state.settings.biz || {};

    const timeEntries = (job.timeEntries || []).slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""));
    const materials = (job.materials || []);

    const grouped = {};
    if(groupDays){
      for(const e of timeEntries){
        grouped[e.date] = grouped[e.date] || {hours:0, cost:0, lines:[]};
        grouped[e.date].hours += Number(e.hours||0);
        grouped[e.date].cost += Number(e.cost||0);
        grouped[e.date].lines.push(e);
      }
    }

    const win = window.open("", "_blank");
    if(!win){ alert("Pop-up blocked. Allow pop-ups to generate PDF."); return; }

    const title = docType==="QUOTE" ? "QUOTE" : "INVOICE / WORK SUMMARY";
    const clientLine = job.client ? `<div><b>Client:</b> ${escapeHtml(job.client)}</div>` : "";
    const locationLine = job.location ? `<div><b>Location:</b> ${escapeHtml(job.location)}</div>` : "";

    const bizBlock = `
      <div class="biz">
        <div class="bn">${escapeHtml(biz.name || "Rust Rebels")}</div>
        <div class="muted">${[biz.address, biz.phone, biz.email].filter(Boolean).map(escapeHtml).join(" • ")}</div>
      </div>
    `;

    const jobBlock = `
      <div class="box">
        <div class="h">${escapeHtml(job.title || "Job")}</div>
        ${clientLine}
        ${locationLine}
        <div><b>Status:</b> ${escapeHtml(statusLabel(job.status || "QUOTE"))}</div>
        <div><b>Hourly rate:</b> $${money(rateUsed)}/hr</div>
        ${job.desc ? `<div class="sp"></div><div class="muted">${escapeHtml(job.desc)}</div>` : ""}
      </div>
    `;

    const totalsBlock = `
      <div class="totals">
        <div class="row"><span>Labour</span><b>$${money(labor.cost)}</b></div>
        <div class="row"><span>Materials</span><b>$${money(mats.cost)}</b></div>
        <div class="row grand"><span>Total (no GST)</span><b>$${money(total)}</b></div>
      </div>
    `;

    const acceptance = docType==="QUOTE" ? `
      <div class="box">
        <div class="h">Acceptance</div>
        <div class="muted">Signature: ____________________________  Date: ____ / ____ / ______</div>
      </div>
    ` : "";

    const timeTable = () => {
      if(!itemised) return "";
      if(timeEntries.length === 0) return `<div class="muted">No labour entries.</div>`;

      if(groupDays){
        const rows = Object.keys(grouped).map(d => `
          <tr>
            <td>${escapeHtml(d)}</td>
            <td class="right">${money(grouped[d].hours)}</td>
            <td class="right">$${money(grouped[d].cost)}</td>
          </tr>
        `).join("");
        return `
          <div class="box">
            <div class="h">Labour (grouped by day)</div>
            <table>
              <thead><tr><th>Date</th><th class="right">Hours</th><th class="right">$</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
      } else {
        const rows = timeEntries.map(e => `
          <tr>
            <td>${escapeHtml(e.date || "")}</td>
            <td>${escapeHtml(e.desc || "")}</td>
            <td class="right">${money(e.hours || 0)}</td>
            <td class="right">$${money(e.cost || 0)}</td>
          </tr>
        `).join("");
        return `
          <div class="box">
            <div class="h">Labour (itemised)</div>
            <table>
              <thead><tr><th>Date</th><th>Description</th><th class="right">Hours</th><th class="right">$</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
      }
    };

    const matTable = () => {
      if(!itemised) return "";
      if(materials.length === 0) return `<div class="muted">No materials/expenses.</div>`;
      const rows = materials.map(m => `
        <tr>
          <td>${escapeHtml(m.item || "")}${m.note ? `<div class="muted">${escapeHtml(m.note)}</div>` : ""}</td>
          <td class="right">${money(m.qty || 0)}</td>
          <td class="right">$${money(m.total || 0)}</td>
        </tr>
      `).join("");
      return `
        <div class="box">
          <div class="h">Materials / Expenses</div>
          <table>
            <thead><tr><th>Item</th><th class="right">Qty</th><th class="right">$</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    };

    win.document.write(`
      <html>
      <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>${escapeHtml(title)} - ${escapeHtml(job.title || "Job")}</title>
        <style>
          body{ font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial; margin: 28px; color:#111; }
          .top{ display:flex; align-items:flex-start; justify-content:space-between; gap:16px; }
          .bn{ font-size: 18px; font-weight: 800; letter-spacing:.2px; }
          .muted{ color:#555; font-size:12px; }
          .doc{ text-align:right; }
          .doc .t{ font-size: 20px; font-weight: 900; }
          .doc .d{ font-size:12px; color:#555; }
          .box{ margin-top: 16px; padding: 14px; border: 1px solid #ddd; border-radius: 12px; }
          .h{ font-weight: 900; margin-bottom: 8px; }
          table{ width:100%; border-collapse:collapse; }
          th, td{ font-size:12px; padding: 8px 6px; border-bottom:1px solid #eee; vertical-align:top; }
          th{ color:#555; text-align:left; }
          .right{ text-align:right; }
          .totals{ margin-top: 16px; padding: 14px; border: 1px solid #ddd; border-radius: 12px; }
          .totals .row{ display:flex; justify-content:space-between; padding: 6px 0; font-size: 13px; }
          .totals .grand{ border-top:1px dashed #ccc; margin-top: 6px; padding-top: 10px; font-size: 15px; }
          .sp{ height:8px; }
          @media print{
            body{ margin: 0.5cm; }
          }
        </style>
      </head>
      <body>
        <div class="top">
          ${bizBlock}
          <div class="doc">
            <div class="t">${escapeHtml(title)}</div>
            <div class="d">Date: ${new Date().toISOString().slice(0,10)}</div>
          </div>
        </div>

        ${jobBlock}
        ${timeTable()}
        ${matTable()}
        ${totalsBlock}
        ${acceptance}

        <div class="muted" style="margin-top:14px">No GST applied.</div>

        <script>
          setTimeout(() => { window.print(); }, 250);
        <\/script>
      </body>
      </html>
    `);
    win.document.close();
  });

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function openJob(id){
    selectedJobId = id;
    renderAll();
    jobCard.scrollIntoView({behavior:"smooth", block:"start"});
  }

  function renderKPIs(){
    const visible = filteredJobs();
    const totalJobs = visible.length;

    let active = 0, quoted = 0, completed = 0;
    let total$ = 0;
    for(const j of visible){
      if(j.status==="IN_PROGRESS") active++;
      if(j.status==="QUOTE") quoted++;
      if(j.status==="COMPLETED" || j.status==="INVOICED") completed++;
      const labor = calcLabor(j);
      const mats = calcMaterials(j);
      total$ += (labor.cost + mats.cost);
    }

    kpis.innerHTML = `
      <span class="pill">Jobs: <b>${totalJobs}</b></span>
      <span class="pill">Quotes: <b>${quoted}</b></span>
      <span class="pill">Active: <b>${active}</b></span>
      <span class="pill">Done: <b>${completed}</b></span>
      <span class="pill">Total value: <b>$${money(total$)}</b></span>
    `;
  }

  function filteredJobs(){
    const q = (search.value || "").trim().toLowerCase();
    const st = filterStatus.value || "";
    return state.jobs.filter(j => {
      const hay = `${j.client} ${j.title} ${j.desc} ${j.notes} ${j.location}`.toLowerCase();
      const okQ = !q || hay.includes(q);
      const okS = !st || j.status === st;
      return okQ && okS;
    });
  }

  function renderJobList(){
    const jobs = filteredJobs();
    jobList.innerHTML = "";
    if(jobs.length === 0){
      jobList.innerHTML = `<div class="muted" style="padding:10px 2px">No jobs yet. Tap “New Job”.</div>`;
      return;
    }
    for(const j of jobs){
      const labor = calcLabor(j);
      const mats = calcMaterials(j);
      const total = labor.cost + mats.cost;
      const el = document.createElement("div");
      el.className = "jobItem";
      el.innerHTML = `
        <div>
          <div class="jobTitle">${escape(j.title || "Job")}</div>
          <div class="jobMeta">${escape(j.client || "No client")} • $${money(total)} • ${money(labor.hours)}h</div>
        </div>
        <div class="badge ${badgeClass(j.status)}">${escape(statusLabel(j.status || "QUOTE"))}</div>
      `;
      el.addEventListener("click", () => openJob(j.id));
      jobList.appendChild(el);
    }
  }

  function escape(s){ return (s ?? "").toString().replaceAll("<","&lt;").replaceAll(">","&gt;"); }

  function renderSelectedJob(){
    const job = getJob(selectedJobId);
    jobCard.classList.toggle("hidden", !job);
    settingsCard.classList.toggle("hidden", !!job);

    if(!job) return;

    jobHeader.textContent = job.title || "Job";
    jobSub.textContent = (job.client ? job.client + " • " : "") + "Updated: " + (job.updatedAt ? job.updatedAt.slice(0,10) : "");

    jobClient.value = job.client || "";
    jobTitle.value = job.title || "";
    jobDesc.value = job.desc || "";
    jobLocation.value = job.location || "";
    jobNotes.value = job.notes || "";
    jobStatus.value = job.status || "QUOTE";
    jobRate.value = job.rateOverride === "" ? "" : (job.rateOverride ?? "");

    // default time inputs
    tRate.value = jobRateResolved(job);
    if(!tDate.value) tDate.value = new Date().toISOString().slice(0,10);

    renderTime(job);
    renderMats(job);

    // set PDF type default based on status
    if(job.status === "QUOTE") pdfType.value = "QUOTE";
    else pdfType.value = "INVOICE";
  }

  function renderTime(job){
    const entries = (job.timeEntries || []).slice().sort((a,b)=> (b.date||"").localeCompare(a.date||""));
    timeTableBody.innerHTML = "";
    let totalH = 0, total$ = 0;

    for(const e of entries){
      totalH += Number(e.hours || 0);
      total$ += Number(e.cost || 0);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escape(e.date||"")}</td>
        <td>${escape(e.desc||"")}</td>
        <td class="right">${money(e.hours||0)}</td>
        <td class="right">$${money(e.cost||0)}</td>
        <td class="right"><button class="btn ghost" data-del="${e.id}" style="padding:8px 10px">Remove</button></td>
      `;
      timeTableBody.appendChild(tr);
    }

    timeTotals.innerHTML = `Total: <b>${money(totalH)}h</b> • Labour: <b>$${money(total$)}</b>`;
    timeTableBody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-del");
        job.timeEntries = (job.timeEntries || []).filter(x => x.id !== id);
        job.updatedAt = new Date().toISOString();
        saveState();
      });
    });
  }

  function renderMats(job){
    const items = (job.materials || []);
    matTableBody.innerHTML = "";
    let total = 0;

    for(const it of items){
      total += Number(it.total || 0);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escape(it.item||"")}${it.note ? `<div class="muted">${escape(it.note)}</div>` : ""}</td>
        <td class="right">${money(it.qty||0)}</td>
        <td class="right">$${money(it.total||0)}</td>
        <td class="right"><button class="btn ghost" data-del="${it.id}" style="padding:8px 10px">Remove</button></td>
      `;
      matTableBody.appendChild(tr);
    }

    matTotals.innerHTML = `Materials: <b>$${money(total)}</b>`;
    matTableBody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-del");
        job.materials = (job.materials || []).filter(x => x.id !== id);
        job.updatedAt = new Date().toISOString();
        saveState();
      });
    });
  }

  function renderAll(){
    initSettings();
    renderKPIs();
    renderJobList();
    renderSelectedJob();
  }

  // Seed sample job first run
  if(state.jobs.length === 0){
    const now = new Date().toISOString();
    state.jobs.push({
      id: uid(),
      client: "Sample Client",
      title: "Sample Job (edit or delete)",
      desc: "Example: Fabricate bracket and install.",
      location: "",
      notes: "This is just a starter so you can see the flow.",
      status: "QUOTE",
      rateOverride: "",
      createdAt: now, updatedAt: now,
      timeEntries: [
        { id: uid(), date: now.slice(0,10), desc:"Measure + fitment", hours: 1.5, rate: 75, cost: 112.50, start:"", end:"", breakMin:0 }
      ],
      materials: [
        { id: uid(), item:"Fasteners", qty: 1, unit: 12, sell: null, total: 12, note:"" }
      ]
    });
    saveState();
  } else {
    renderAll();
  }

<script>
(() => {
  /***********************
   * 1) SUPABASE CONFIG  *
   ***********************/
  const SUPABASE_URL = "https://byeugnubtwdnlyzxcegf.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_zc6vOE2kCKmOLOLQUr1P5Q_nQHO1LzI";

  // If you choose "offline mode", app works like before (device-only)
  let OFFLINE_MODE = false;

  const sb = (window.supabase && SUPABASE_URL.includes("http"))
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    : null;

  /***********************
   * 2) LOCAL FALLBACK   *
   ***********************/
  const STORAGE_KEY = "rr_quotes_hours_v2_local_cache";

  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
  const money = (n) => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  const hoursFromTimes = (start, end, breakMin) => {
    if(!start || !end) return null;
    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);
    let mins = (eh*60+em) - (sh*60+sm);
    if(mins < 0) mins += 24*60;
    mins -= Number(breakMin || 0);
    return Math.max(0, mins/60);
  };

  const state = loadLocalCache();

  function loadLocalCache(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      try { return JSON.parse(raw); } catch {}
    }
    return {
      settings: {
        defaultRate: 75,
        biz: { name: "Rust Rebels", phone:"", email:"", address:"" }
      },
      jobs: []
    };
  }

  function saveLocalCache(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  /***********************
   * 3) DOM HOOKS        *
   ***********************/
  const authModal = document.getElementById("authModal");
  const authEmail = document.getElementById("authEmail");
  const authPassword = document.getElementById("authPassword");
  const authMsg = document.getElementById("authMsg");
  const btnLogin = document.getElementById("btnLogin");
  const btnSignup = document.getElementById("btnSignup");
  const btnOffline = document.getElementById("btnOffline");

  const jobList = document.getElementById("jobList");
  const jobCard = document.getElementById("jobCard");
  const settingsCard = document.getElementById("settingsCard");
  const kpis = document.getElementById("kpis");

  const search = document.getElementById("search");
  const filterStatus = document.getElementById("filterStatus");

  const defaultRate = document.getElementById("defaultRate");
  const bizName = document.getElementById("bizName");
  const bizPhone = document.getElementById("bizPhone");
  const bizEmail = document.getElementById("bizEmail");
  const bizAddress = document.getElementById("bizAddress");
  const rateFooter = document.getElementById("rateFooter");
  const newJobBtn = document.getElementById("newJobBtn");
  const closeJobBtn = document.getElementById("closeJobBtn");
  const deleteJobBtn = document.getElementById("deleteJobBtn");
  const saveJobBtn = document.getElementById("saveJobBtn");
  const backupBtn = document.getElementById("backupBtn");
  const wipeBtn = document.getElementById("wipeBtn");
  const importFile = document.getElementById("importFile");
  const exportCsvBtn = document.getElementById("exportCsvBtn");

  const jobHeader = document.getElementById("jobHeader");
  const jobSub = document.getElementById("jobSub");
  const jobClient = document.getElementById("jobClient");
  const jobTitle = document.getElementById("jobTitle");
  const jobDesc = document.getElementById("jobDesc");
  const jobLocation = document.getElementById("jobLocation");
  const jobNotes = document.getElementById("jobNotes");
  const jobStatus = document.getElementById("jobStatus");
  const jobRate = document.getElementById("jobRate");

  const tDate = document.getElementById("tDate");
  const tRate = document.getElementById("tRate");
  const tStart = document.getElementById("tStart");
  const tEnd = document.getElementById("tEnd");
  const tDuration = document.getElementById("tDuration");
  const tBreak = document.getElementById("tBreak");
  const tDesc = document.getElementById("tDesc");
  const addTimeBtn = document.getElementById("addTimeBtn");
  const timeTableBody = document.querySelector("#timeTable tbody");
  const timeTotals = document.getElementById("timeTotals");

  const mItem = document.getElementById("mItem");
  const mQty = document.getElementById("mQty");
  const mUnit = document.getElementById("mUnit");
  const mSell = document.getElementById("mSell");
  const mNote = document.getElementById("mNote");
  const addMatBtn = document.getElementById("addMatBtn");
  const matTableBody = document.querySelector("#matTable tbody");
  const matTotals = document.getElementById("matTotals");

  const pdfType = document.getElementById("pdfType");
  const pdfItemised = document.getElementById("pdfItemised");
  const pdfGroupDays = document.getElementById("pdfGroupDays");
  const genPdfBtn = document.getElementById("genPdfBtn");

  const tabs = Array.from(document.querySelectorAll(".tab"));
  const tabPanels = {
    details: document.getElementById("tab-details"),
    time: document.getElementById("tab-time"),
    materials: document.getElementById("tab-materials"),
    pdf: document.getElementById("tab-pdf"),
  };

  let selectedJobId = null;
  let currentUser = null;

  /***********************
   * 4) AUTH FLOW        *
   ***********************/
  function showAuth(show, msg=""){
    if(!sb){ OFFLINE_MODE = true; show = false; }
    authModal.style.display = show ? "flex" : "none";
    authMsg.textContent = msg;
  }

  async function initAuth(){
    if(!sb){
      OFFLINE_MODE = true;
      renderAll();
      return;
    }

    const { data } = await sb.auth.getSession();
    currentUser = data?.session?.user || null;

    if(!currentUser){
      showAuth(true, "Log in or sign up to enable sync.");
      renderAll(); // still renders local cache
    } else {
      showAuth(false);
      await cloudPullAll();      // load from cloud
      renderAll();
      startRealtime();           // keep devices in sync
    }
  }

  btnOffline.addEventListener("click", () => {
    OFFLINE_MODE = true;
    showAuth(false);
    renderAll();
  });

  btnSignup.addEventListener("click", async () => {
    if(!sb) return;
    authMsg.textContent = "Signing up…";
    const email = authEmail.value.trim();
    const password = authPassword.value;
    const { error } = await sb.auth.signUp({ email, password });
    authMsg.textContent = error ? error.message : "Check your email if confirmation is enabled, then log in.";
  });

  btnLogin.addEventListener("click", async () => {
    if(!sb) return;
    authMsg.textContent = "Logging in…";
    const email = authEmail.value.trim();
    const password = authPassword.value;
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error){
      authMsg.textContent = error.message;
      return;
    }
    currentUser = data.user;
    showAuth(false);
    await cloudPullAll();
    renderAll();
    startRealtime();
  });

  /***********************
   * 5) CLOUD OPERATIONS *
   ***********************/
  function assertUser(){
    if(OFFLINE_MODE) return null;
    if(!currentUser) throw new Error("Not logged in");
    return currentUser.id;
  }

  async function cloudPullAll(){
    const userId = assertUser();
    if(!userId) return;

    // Load settings from local cache only (simpler). You can also store settings in Supabase later.
    // Pull Jobs
    const { data: jobs, error: ej } = await sb
      .from("jobs")
      .select("*")
      .order("updated_at", { ascending: false });

    if(ej) { console.error(ej); return; }

    // Pull time entries + materials in one go
    const { data: te, error: et } = await sb.from("time_entries").select("*");
    const { data: ma, error: em } = await sb.from("materials").select("*");
    if(et) console.error(et);
    if(em) console.error(em);

    // Merge into app state structure
    const timeByJob = {};
    (te || []).forEach(e => {
      const jobId = e.job_id;
      timeByJob[jobId] = timeByJob[jobId] || [];
      timeByJob[jobId].push({
        id: e.id,
        date: e.work_date,
        desc: e.description || "",
        hours: Number(e.hours || 0),
        rate: Number(e.rate || 0),
        cost: Number(e.cost || 0),
        start: "",
        end: "",
        breakMin: 0
      });
    });

    const matsByJob = {};
    (ma || []).forEach(m => {
      const jobId = m.job_id;
      matsByJob[jobId] = matsByJob[jobId] || [];
      matsByJob[jobId].push({
        id: m.id,
        item: m.item || "",
        qty: Number(m.qty || 0),
        unit: Number(m.unit_cost || 0),
        sell: null,
        total: Number(m.total || 0),
        note: m.note || ""
      });
    });

    state.jobs = (jobs || []).map(j => ({
      id: j.id,
      client: j.client || "",
      title: j.title || "",
      desc: j.description || "",
      location: j.location || "",
      notes: j.notes || "",
      status: j.status || "QUOTE",
      rateOverride: (j.rate_override ?? ""),
      createdAt: j.created_at,
      updatedAt: j.updated_at,
      timeEntries: timeByJob[j.id] || [],
      materials: matsByJob[j.id] || []
    }));

    saveLocalCache(); // keep a local mirror
  }

  async function cloudUpsertJob(job){
    const userId = assertUser();
    if(!userId) return;

    const payload = {
      id: job.id, // keep same id
      user_id: userId,
      client: job.client,
      title: job.title,
      description: job.desc,
      location: job.location,
      notes: job.notes,
      status: job.status,
      rate_override: (job.rateOverride === "" ? null : job.rateOverride),
      updated_at: new Date().toISOString()
    };

    const { error } = await sb.from("jobs").upsert(payload);
    if(error) console.error(error);
  }

  async function cloudDeleteJob(jobId){
    const userId = assertUser();
    if(!userId) return;
    const { error } = await sb.from("jobs").delete().eq("id", jobId);
    if(error) console.error(error);
  }

  async function cloudInsertTime(jobId, entry){
    const userId = assertUser();
    if(!userId) return;

    const payload = {
      id: entry.id,
      user_id: userId,
      job_id: jobId,
      work_date: entry.date,
      description: entry.desc,
      hours: entry.hours,
      rate: entry.rate,
      cost: entry.cost
    };

    const { error } = await sb.from("time_entries").insert(payload);
    if(error) console.error(error);
  }

  async function cloudDeleteTime(entryId){
    const userId = assertUser();
    if(!userId) return;
    const { error } = await sb.from("time_entries").delete().eq("id", entryId);
    if(error) console.error(error);
  }

  async function cloudInsertMat(jobId, item){
    const userId = assertUser();
    if(!userId) return;

    const payload = {
      id: item.id,
      user_id: userId,
      job_id: jobId,
      item: item.item,
      qty: item.qty,
      unit_cost: item.unit,
      total: item.total,
      note: item.note
    };

    const { error } = await sb.from("materials").insert(payload);
    if(error) console.error(error);
  }

  async function cloudDeleteMat(itemId){
    const userId = assertUser();
    if(!userId) return;
    const { error } = await sb.from("materials").delete().eq("id", itemId);
    if(error) console.error(error);
  }

  /***********************
   * 6) REALTIME SYNC    *
   ***********************/
  let rtStarted = false;
  function startRealtime(){
    if(OFFLINE_MODE || !sb || rtStarted) return;
    rtStarted = true;

    // When anything changes, just pull again (simple + reliable).
    // Later we can optimize to merge incremental updates.
    const ch = sb.channel("rr-sync")
      .on("postgres_changes", { event: "*", schema: "public", table: "jobs" }, () => cloudPullAll().then(renderAll))
      .on("postgres_changes", { event: "*", schema: "public", table: "time_entries" }, () => cloudPullAll().then(renderAll))
      .on("postgres_changes", { event: "*", schema: "public", table: "materials" }, () => cloudPullAll().then(renderAll))
      .subscribe();

    // NOTE: If realtime doesn’t trigger, enable replication in Supabase:
    // Database -> Replication -> enable for these tables.
  }

  /***********************
   * 7) APP LOGIC        *
   ***********************/
  function getJob(id){ return state.jobs.find(j => j.id === id); }
  function jobRateResolved(job){
    const r = job.rateOverride;
    return (r !== null && r !== undefined && r !== "") ? Number(r) : Number(state.settings.defaultRate || 0);
  }

  function calcLabor(job){
    const entries = job.timeEntries || [];
    let totalH = 0, total$ = 0;
    for(const e of entries){ totalH += Number(e.hours||0); total$ += Number(e.cost||0); }
    return { hours: totalH, cost: total$ };
  }
  function calcMaterials(job){
    const items = job.materials || [];
    let total = 0;
    for(const it of items){ total += Number(it.total||0); }
    return { cost: total };
  }

  function badgeClass(status){
    if(status==="QUOTE") return "quote";
    if(status==="IN_PROGRESS") return "progress";
    if(status==="COMPLETED") return "done";
    if(status==="INVOICED") return "invoiced";
    return "";
  }
  function statusLabel(status){
    return status==="IN_PROGRESS" ? "In Progress" : status.charAt(0)+status.slice(1).toLowerCase().replace("_"," ");
  }

  function initSettings(){
    defaultRate.value = state.settings.defaultRate ?? 75;
    bizName.value = state.settings.biz?.name ?? "Rust Rebels";
    bizPhone.value = state.settings.biz?.phone ?? "";
    bizEmail.value = state.settings.biz?.email ?? "";
    bizAddress.value = state.settings.biz?.address ?? "";
    rateFooter.textContent = "$" + money(state.settings.defaultRate ?? 75);
  }

  defaultRate.addEventListener("input", () => { state.settings.defaultRate = Number(defaultRate.value||0); saveLocalCache(); renderAll(); });
  for(const [el, key] of [[bizName,"name"],[bizPhone,"phone"],[bizEmail,"email"],[bizAddress,"address"]]){
    el.addEventListener("input", () => {
      state.settings.biz = state.settings.biz || {};
      state.settings.biz[key] = el.value;
      saveLocalCache(); renderAll();
    });
  }

  newJobBtn.addEventListener("click", async () => {
    const now = new Date().toISOString();
    const job = {
      id: uid(),
      client: "",
      title: "New job",
      desc: "",
      location: "",
      notes: "",
      status: "QUOTE",
      rateOverride: "",
      createdAt: now,
      updatedAt: now,
      timeEntries: [],
      materials: []
    };
    state.jobs.unshift(job);
    selectedJobId = job.id;
    saveLocalCache();
    renderAll();
    openJob(job.id);

    await cloudUpsertJob(job); // live save
  });

  closeJobBtn.addEventListener("click", () => { selectedJobId = null; renderAll(); });

  deleteJobBtn.addEventListener("click", async () => {
    const job = getJob(selectedJobId);
    if(!job) return;
    if(confirm("Delete this job? This cannot be undone.")){
      const id = selectedJobId;
      state.jobs = state.jobs.filter(j => j.id !== id);
      selectedJobId = null;
      saveLocalCache();
      renderAll();
      await cloudDeleteJob(id);
    }
  });

  saveJobBtn.addEventListener("click", async () => {
    const job = getJob(selectedJobId);
    if(!job) return;

    job.client = jobClient.value.trim();
    job.title = jobTitle.value.trim();
    job.desc = jobDesc.value.trim();
    job.location = jobLocation.value.trim();
    job.notes = jobNotes.value.trim();
    job.status = jobStatus.value;
    job.rateOverride = jobRate.value === "" ? "" : Number(jobRate.value);
    job.updatedAt = new Date().toISOString();

    saveLocalCache();
    renderAll();
    await cloudUpsertJob(job);
    alert("Saved.");
  });

  search.addEventListener("input", renderAll);
  filterStatus.addEventListener("change", renderAll);

  addTimeBtn.addEventListener("click", async () => {
    const job = getJob(selectedJobId);
    if(!job) return;

    const date = tDate.value || new Date().toISOString().slice(0,10);
    const rate = Number(tRate.value || jobRateResolved(job));
    const br = Number(tBreak.value || 0);

    let hrs = null;
    const fromTimes = hoursFromTimes(tStart.value, tEnd.value, br);
    if(fromTimes !== null) hrs = fromTimes;

    const dur = tDuration.value !== "" ? Number(tDuration.value) : null;
    if(dur !== null && !isNaN(dur) && dur > 0) hrs = (dur - (br/60));

    if(hrs === null || isNaN(hrs) || hrs <= 0){
      alert("Enter start/end time OR a duration (hours).");
      return;
    }

    const desc = tDesc.value.trim() || "Work";
    const cost = hrs * rate;

    const entry = {
      id: uid(),
      date,
      desc,
      hours: Number(hrs.toFixed(2)),
      rate,
      cost: Number(cost.toFixed(2)),
      start: tStart.value || "",
      end: tEnd.value || "",
      breakMin: br
    };

    job.timeEntries.push(entry);
    job.updatedAt = new Date().toISOString();

    tStart.value=""; tEnd.value=""; tDuration.value=""; tDesc.value=""; tBreak.value="0";

    saveLocalCache();
    renderAll();
    await cloudUpsertJob(job);
    await cloudInsertTime(job.id, entry);
  });

  addMatBtn.addEventListener("click", async () => {
    const job = getJob(selectedJobId);
    if(!job) return;

    const itemName = mItem.value.trim();
    if(!itemName){ alert("Enter an item name."); return; }

    const qty = Number(mQty.value || 1);
    const unit = Number(mUnit.value || 0);
    const sellOverride = (mSell.value === "" ? null : Number(mSell.value));
    const total = sellOverride !== null ? sellOverride : qty * unit;

    const item = {
      id: uid(),
      item: itemName,
      qty: Number(qty.toFixed(2)),
      unit: Number(unit.toFixed(2)),
      sell: sellOverride,
      total: Number(total.toFixed(2)),
      note: mNote.value.trim()
    };

    job.materials.push(item);
    job.updatedAt = new Date().toISOString();

    mItem.value=""; mQty.value="1"; mUnit.value="0"; mSell.value=""; mNote.value="";

    saveLocalCache();
    renderAll();
    await cloudUpsertJob(job);
    await cloudInsertMat(job.id, item);
  });

  // Remove time/material (cloud + local)
  function wireRemovalButtons(){
    const job = getJob(selectedJobId);
    if(!job) return;

    document.querySelectorAll("#timeTable button[data-del]").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute("data-del");
        job.timeEntries = (job.timeEntries||[]).filter(x => x.id !== id);
        job.updatedAt = new Date().toISOString();
        saveLocalCache(); renderAll();
        await cloudDeleteTime(id);
        await cloudUpsertJob(job);
      };
    });

    document.querySelectorAll("#matTable button[data-del]").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.getAttribute("data-del");
        job.materials = (job.materials||[]).filter(x => x.id !== id);
        job.updatedAt = new Date().toISOString();
        saveLocalCache(); renderAll();
        await cloudDeleteMat(id);
        await cloudUpsertJob(job);
      };
    });
  }

  // Tabs
  tabs.forEach(btn => btn.addEventListener("click", () => {
    tabs.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    const name = btn.dataset.tab;
    Object.entries(tabPanels).forEach(([k, el]) => el.classList.toggle("hidden", k !== name));
  }));

  // Backup/export still works (local mirror)
  backupBtn.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    downloadBlob(blob, `rust-rebels-backup-${new Date().toISOString().slice(0,10)}.json`);
  });
  importFile.addEventListener("change", async () => {
    const f = importFile.files?.[0];
    if(!f) return;
    try{
      const txt = await f.text();
      const obj = JSON.parse(txt);
      if(!obj || !obj.settings || !obj.jobs) throw new Error("Invalid backup");
      if(confirm("Import backup into THIS device mirror? (You can then upload to cloud by saving each job)")){
        state.settings = obj.settings;
        state.jobs = obj.jobs;
        selectedJobId = null;
        saveLocalCache();
        renderAll();
      }
    }catch(e){
      alert("Could not import: " + e.message);
    }finally{
      importFile.value = "";
    }
  });

  wipeBtn.addEventListener("click", async () => {
    if(confirm("Clear ALL local data on this device?")){
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
  });

  exportCsvBtn.addEventListener("click", () => {
    const rows = [];
    rows.push(["JobID","Client","Title","Status","Rate","LaborHours","LaborCost","MaterialsCost","Total","UpdatedAt"].join(","));
    for(const j of state.jobs){
      const r = jobRateResolved(j);
      const labor = calcLabor(j);
      const mats = calcMaterials(j);
      const total = labor.cost + mats.cost;
      rows.push([
        j.id, csv(j.client), csv(j.title), j.status, r,
        labor.hours.toFixed(2), labor.cost.toFixed(2), mats.cost.toFixed(2), total.toFixed(2), j.updatedAt
      ].join(","));
    }
    const blob = new Blob([rows.join("\n")], {type:"text/csv"});
    downloadBlob(blob, `rust-rebels-jobs-${new Date().toISOString().slice(0,10)}.csv`);
  });

  function csv(s){
    const x = (s ?? "").toString().replaceAll('"','""');
    return `"${x}"`;
  }
  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

  // Rendering
  function filteredJobs(){
    const q = (search.value||"").trim().toLowerCase();
    const st = filterStatus.value || "";
    return state.jobs.filter(j => {
      const hay = `${j.client} ${j.title} ${j.desc} ${j.notes} ${j.location}`.toLowerCase();
      const okQ = !q || hay.includes(q);
      const okS = !st || j.status === st;
      return okQ && okS;
    });
  }

  function renderKPIs(){
    const visible = filteredJobs();
    let active=0, quoted=0, completed=0, total$=0;
    for(const j of visible){
      if(j.status==="IN_PROGRESS") active++;
      if(j.status==="QUOTE") quoted++;
      if(j.status==="COMPLETED" || j.status==="INVOICED") completed++;
      const labor = calcLabor(j);
      const mats = calcMaterials(j);
      total$ += labor.cost + mats.cost;
    }
    kpis.innerHTML = `
      <span class="pill">Jobs: <b>${visible.length}</b></span>
      <span class="pill">Quotes: <b>${quoted}</b></span>
      <span class="pill">Active: <b>${active}</b></span>
      <span class="pill">Done: <b>${completed}</b></span>
      <span class="pill">Total value: <b>$${money(total$)}</b></span>
    `;
  }

  function renderJobList(){
    const jobs = filteredJobs();
    jobList.innerHTML = "";
    if(jobs.length === 0){
      jobList.innerHTML = `<div class="muted" style="padding:10px 2px">No jobs yet. Tap “New Job”.</div>`;
      return;
    }
    for(const j of jobs){
      const labor = calcLabor(j);
      const mats = calcMaterials(j);
      const total = labor.cost + mats.cost;
      const el = document.createElement("div");
      el.className = "jobItem";
      el.innerHTML = `
        <div>
          <div class="jobTitle">${escape(j.title || "Job")}</div>
          <div class="jobMeta">${escape(j.client || "No client")} • $${money(total)} • ${money(labor.hours)}h</div>
        </div>
        <div class="badge ${badgeClass(j.status)}">${escape(statusLabel(j.status || "QUOTE"))}</div>
      `;
      el.addEventListener("click", () => openJob(j.id));
      jobList.appendChild(el);
    }
  }

  function openJob(id){
    selectedJobId = id;
    renderAll();
    jobCard.scrollIntoView({behavior:"smooth", block:"start"});
  }

  function renderSelectedJob(){
    const job = getJob(selectedJobId);
    jobCard.classList.toggle("hidden", !job);
    settingsCard.classList.toggle("hidden", !!job);

    if(!job) return;

    jobHeader.textContent = job.title || "Job";
    jobSub.textContent = (job.client ? job.client + " • " : "") + "Updated: " + (job.updatedAt ? job.updatedAt.slice(0,10) : "");

    jobClient.value = job.client || "";
    jobTitle.value = job.title || "";
    jobDesc.value = job.desc || "";
    jobLocation.value = job.location || "";
    jobNotes.value = job.notes || "";
    jobStatus.value = job.status || "QUOTE";
    jobRate.value = job.rateOverride === "" ? "" : (job.rateOverride ?? "");

    tRate.value = jobRateResolved(job);
    if(!tDate.value) tDate.value = new Date().toISOString().slice(0,10);

    renderTime(job);
    renderMats(job);

    if(job.status === "QUOTE") pdfType.value = "QUOTE";
    else pdfType.value = "INVOICE";

    wireRemovalButtons();
  }

  function renderTime(job){
    const entries = (job.timeEntries || []).slice().sort((a,b)=> (b.date||"").localeCompare(a.date||""));
    timeTableBody.innerHTML = "";
    let totalH=0, total$=0;
    for(const e of entries){
      totalH += Number(e.hours||0);
      total$ += Number(e.cost||0);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escape(e.date||"")}</td>
        <td>${escape(e.desc||"")}</td>
        <td class="right">${money(e.hours||0)}</td>
        <td class="right">$${money(e.cost||0)}</td>
        <td class="right"><button class="btn ghost" data-del="${e.id}" style="padding:8px 10px">Remove</button></td>
      `;
      timeTableBody.appendChild(tr);
    }
    timeTotals.innerHTML = `Total: <b>${money(totalH)}h</b> • Labour: <b>$${money(total$)}</b>`;
  }

  function renderMats(job){
    const items = (job.materials || []);
    matTableBody.innerHTML = "";
    let total=0;
    for(const it of items){
      total += Number(it.total||0);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escape(it.item||"")}${it.note ? `<div class="muted">${escape(it.note)}</div>` : ""}</td>
        <td class="right">${money(it.qty||0)}</td>
        <td class="right">$${money(it.total||0)}</td>
        <td class="right"><button class="btn ghost" data-del="${it.id}" style="padding:8px 10px">Remove</button></td>
      `;
      matTableBody.appendChild(tr);
    }
    matTotals.innerHTML = `Materials: <b>$${money(total)}</b>`;
  }

  function escape(s){ return (s ?? "").toString().replaceAll("<","&lt;").replaceAll(">","&gt;"); }

  function renderAll(){
    initSettings();
    renderKPIs();
    renderJobList();
    renderSelectedJob();
    saveLocalCache();
  }

  /***********************
   * 8) PDF: keep yours  *
   ***********************/
  // Your existing PDF code should remain as-is above this script in your file.
  // If your old version had PDF in this script, keep it (don’t delete it).
  // The sync changes don’t affect PDF.

  // IMPORTANT NOTE:
  // If you replaced your whole script and lost the PDF function,
  // tell me and I’ll paste the PDF part back in cleanly.

  // Start
  renderAll();
  initAuth();

})();
</script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</body>
</html>
